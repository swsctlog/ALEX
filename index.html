<!DOCTYPE html>
<html lang="ru" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Элегантная Аналитическая Панель</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Lightweight Charts -->
    <script src="https://unpkg.com/lightweight-charts@3.8.0/dist/lightweight-charts.standalone.production.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        :root {
            --bs-body-font-family: 'Inter', sans-serif;
            --bs-body-bg: #131722;
            --bs-body-color: #d1d4dc;
            --card-bg: #1e222d;
            --border-color: #2a2e39;
            --accent-green: #26a69a;
            --accent-red: #ef5350;
            --accent-blue: #2962ff;
            --accent-yellow: #ffeb3b;
        }

        body {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .card {
            background-color: var(--card-bg);
            border-color: var(--border-color);
            border-radius: 0.75rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .search-container .form-control {
            background-color: var(--card-bg);
            border-color: var(--border-color);
            padding-left: 2.5rem;
        }
        .search-container .form-control:focus {
            background-color: var(--card-bg);
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 0.25rem rgba(var(--bs-primary-rgb), 0.25);
            color: var(--bs-body-color);
        }
        .search-icon {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: #8c919e;
        }
        
        #suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-top: none;
            border-radius: 0 0 0.5rem 0.5rem;
            z-index: 1000;
        }
        .suggestion-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
        }
        .suggestion-item:hover {
            background-color: var(--accent-blue);
        }
        
        .btn-icon {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            color: #8c919e;
        }
        .btn-icon:hover {
            background-color: #2a2e39;
            color: var(--bs-body-color);
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        .indicator-value { font-size: 1.5rem; font-weight: 600; }
        .indicator-label { color: #8c919e; font-size: 0.8rem; }
        
        .news-item { border-bottom: 1px solid var(--border-color); }
        .news-item:last-child { border-bottom: none; }
        .news-item a { text-decoration: none; color: var(--bs-body-color); }
        .news-item a:hover .news-title { color: var(--accent-blue); }
        .news-title { font-weight: 500; transition: color 0.2s; }
        .news-source { font-size: 0.75rem; color: #8c919e; }
        
        #prediction-signal { font-size: 3.5rem; font-weight: 700; margin: 0.5rem 0; }
        #countdown-timer { font-size: 1.5rem; font-weight: 600; color: var(--accent-yellow); }

        .sentiment-buy { color: var(--accent-green); }
        .sentiment-sell { color: var(--accent-red); }
        .sentiment-hold { color: #8c919e; }
        .sentiment-loading { color: var(--accent-blue); }
        .sentiment-error { color: var(--accent-yellow); }
    </style>
</head>
<body>

    <div class="container-fluid p-3 p-md-4">
        <header class="d-flex justify-content-between align-items-center mb-4 gap-3 flex-wrap">
            <div class="search-container position-relative flex-grow-1" style="max-width: 400px;">
                <i data-lucide="search" class="search-icon"></i>
                <input type="text" id="symbol-search" class="form-control" placeholder="Поиск (напр. EURUSD)...">
                <div id="suggestions" class="list-group" style="display: none;"></div>
            </div>
            <button id="reload-btn" class="btn btn-icon rounded-circle" title="Обновить данные">
                <i data-lucide="refresh-cw" style="width: 20px; height: 20px;"></i>
            </button>
        </header>

        <div class="row g-4">
            <!-- Основной контент -->
            <main class="col-lg-8">
                <div class="card h-100">
                    <div class="card-body d-flex flex-column">
                       <h1 id="chart-title" class="card-title fs-5 mb-3"></h1>
                       <div id="chart-container" class="flex-grow-1 position-relative">
                           <div id="chart-loader" class="position-absolute top-50 start-50 translate-middle" style="display: none;">Загрузка...</div>
                       </div>
                    </div>
                </div>
            </main>

            <!-- Боковая панель -->
            <aside class="col-lg-4">
                <div class="vstack gap-4">
                    <div class="card">
                        <div class="card-body text-center">
                            <h2 class="card-title justify-content-center fs-6"><i data-lucide="brain-circuit"></i>Автоматический Прогноз</h2>
                            <div id="prediction-signal" class="sentiment-hold">ОЖИДАНИЕ</div>
                            <div id="prediction-timing" class="text-secondary">Анализ...</div>
                            <div id="countdown-timer" class="mt-2"></div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-body">
                             <h2 class="card-title justify-content-center fs-6"><i data-lucide="sliders-horizontal"></i>Параметры сделки</h2>
                             <div class="row text-center">
                                 <div class="col">
                                     <div class="indicator-label">Размер позиции</div>
                                     <div id="position-size-value" class="indicator-value">-</div>
                                 </div>
                                 <div class="col">
                                     <div class="indicator-label">Плечо/Мультипликатор</div>
                                     <div id="leverage-value" class="indicator-value">-</div>
                                 </div>
                             </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-body">
                             <h2 class="card-title justify-content-center fs-6"><i data-lucide="activity"></i>Тех. Индикаторы</h2>
                             <div class="row text-center">
                                 <div class="col-6 col-md-3 col-lg-6 mb-3"><div class="indicator-label">RSI</div><div id="rsi-value" class="indicator-value">-</div></div>
                                 <div class="col-6 col-md-3 col-lg-6 mb-3"><div class="indicator-label">EMA</div><div id="ema-value" class="indicator-value">-</div></div>
                                 <div class="col-6 col-md-3 col-lg-6 mb-3"><div class="indicator-label">MACD</div><div id="macd-value" class="indicator-value">-</div></div>
                                 <div class="col-6 col-md-3 col-lg-6 mb-3"><div class="indicator-label">Настроение</div><div id="sentiment-value" class="indicator-value">-</div></div>
                             </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-body">
                            <h2 class="card-title fs-6"><i data-lucide="newspaper"></i>Новости</h2>
                            <div id="news-feed" style="max-height: 250px; overflow-y: auto;">
                                <div id="news-loader" class="text-center text-secondary py-3">Загрузка...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </aside>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        lucide.createIcons();

        const elements = {
            chartContainer: document.getElementById('chart-container'),
            chartTitle: document.getElementById('chart-title'),
            chartLoader: document.getElementById('chart-loader'),
            newsLoader: document.getElementById('news-loader'),
            newsFeed: document.getElementById('news-feed'),
            symbolSearch: document.getElementById('symbol-search'),
            suggestions: document.getElementById('suggestions'),
            reloadBtn: document.getElementById('reload-btn'),
            predictionSignal: document.getElementById('prediction-signal'),
            predictionTiming: document.getElementById('prediction-timing'),
            countdownTimer: document.getElementById('countdown-timer'),
            rsiValue: document.getElementById('rsi-value'),
            emaValue: document.getElementById('ema-value'),
            macdValue: document.getElementById('macd-value'),
            sentimentValue: document.getElementById('sentiment-value'),
            positionSizeValue: document.getElementById('position-size-value'),
            leverageValue: document.getElementById('leverage-value'),
        };

        const API_KEYS = {
            fmp: '3nVpDnD5hpLCCKMBY4GpwsDbBPeJAGch',
            newsData: 'pub_83547d6115524ae3a8569c8daaaa7a7a',
            gemini: 'AIzaSyCjJCqBok3BFu0iDghJsuOTaTjqWaH0Ck8'
        };
        const POPULAR_SYMBOLS = ['EURUSD', 'GBPUSD', 'USDJPY', 'USDAUD', 'USDCAD', 'USDCHF', 'XAUUSD', 'BTCUSD'];

        let currentSymbol = localStorage.getItem('tradingDashboardSymbol') || 'USDAUD';
        let fromSymbolNews = '', toSymbolNews = '';
        const INTERVAL = '1min';
        
        let chart, candleSeries, priceData = [], newsData = [], scoreHistory = [];
        let currentSignal = 'HOLD', signalTimestamp = 0, signalExitTimestamp = 0;
        let countdownInterval;

        const MIN_SIGNAL_DURATION = 3 * 60 * 1000;
        const SCORE_HISTORY_LENGTH = 5;
        const SIGNAL_SCORE_THRESHOLD = 2.0;

        // === ИНИЦИАЛИЗАЦИЯ ===
        function init() {
            initChart();
            setupEventListeners();
            parseSymbol(currentSymbol);
            fetchAllData();
            setInterval(fetchAllData, 30000);
        }

        function initChart() {
            if (chart) chart.remove();
            
            const chartColors = {
                background: getComputedStyle(document.documentElement).getPropertyValue('--card-bg').trim(),
                text: getComputedStyle(document.documentElement).getPropertyValue('--bs-body-color').trim(),
                border: getComputedStyle(document.documentElement).getPropertyValue('--border-color').trim(),
                accentGreen: getComputedStyle(document.documentElement).getPropertyValue('--accent-green').trim(),
                accentRed: getComputedStyle(document.documentElement).getPropertyValue('--accent-red').trim()
            };

            chart = LightweightCharts.createChart(elements.chartContainer, {
                layout: { backgroundColor: chartColors.background, textColor: chartColors.text },
                grid: { vertLines: { color: chartColors.border }, horzLines: { color: chartColors.border } },
                timeScale: { timeVisible: true, secondsVisible: false, borderColor: chartColors.border },
                crosshair: { mode: LightweightCharts.CrosshairMode.Normal }
            });

            candleSeries = chart.addCandlestickSeries({
                upColor: chartColors.accentGreen, downColor: chartColors.accentRed,
                borderDownColor: chartColors.accentRed, borderUpColor: chartColors.accentGreen,
                wickDownColor: chartColors.accentRed, wickUpColor: chartColors.accentGreen,
            });
            window.addEventListener('resize', () => chart.resize(elements.chartContainer.clientWidth, elements.chartContainer.clientHeight));
        }

        function setupEventListeners() {
            elements.reloadBtn.addEventListener('click', () => {
                elements.reloadBtn.querySelector('svg').classList.add('animate-spin');
                fetchAllData().finally(() => {
                    setTimeout(() => elements.reloadBtn.querySelector('svg').classList.remove('animate-spin'), 500);
                });
            });

            elements.symbolSearch.addEventListener('input', showSuggestions);
            elements.symbolSearch.addEventListener('focus', showSuggestions);
            document.addEventListener('click', (e) => {
                if (!elements.searchContainer.contains(e.target)) elements.suggestions.style.display = 'none';
            });
        }
        
        // === УПРАВЛЕНИЕ СИМВОЛОМ ===
        function parseSymbol(symbol) {
             if (symbol.length === 6) { fromSymbolNews = symbol.substring(0, 3); toSymbolNews = symbol.substring(3, 6); } 
             else { fromSymbolNews = symbol; toSymbolNews = 'USD'; }
            elements.chartTitle.innerHTML = `<i data-lucide="line-chart"></i> График ${fromSymbolNews}/${toSymbolNews} (${INTERVAL})`;
            lucide.createIcons();
        }

        function changeSymbol(newSymbol) {
            currentSymbol = newSymbol;
            localStorage.setItem('tradingDashboardSymbol', newSymbol);
            parseSymbol(newSymbol);
            
            priceData = []; newsData = []; scoreHistory = [];
            currentSignal = 'HOLD';
            elements.predictionSignal.textContent = 'ОЖИДАНИЕ';
            elements.predictionTiming.textContent = 'Анализ...';
            stopCountdown();
            fetchAllData();
        }

        function showSuggestions() {
            const query = elements.symbolSearch.value.toUpperCase();
            const filtered = POPULAR_SYMBOLS.filter(s => s.includes(query));
            elements.suggestions.innerHTML = '';
            if (filtered.length > 0) {
                filtered.forEach(s => {
                    const item = document.createElement('a');
                    item.className = 'suggestion-item list-group-item list-group-item-action';
                    item.textContent = s;
                    item.onclick = () => {
                        elements.symbolSearch.value = s;
                        elements.suggestions.style.display = 'none';
                        changeSymbol(s);
                    };
                    elements.suggestions.appendChild(item);
                });
                elements.suggestions.style.display = 'block';
            } else {
                elements.suggestions.style.display = 'none';
            }
        }

        function updateChart(data) {
            if (candleSeries) candleSeries.setData(data);
            chart.timeScale().fitContent();
        }

        // === ЗАГРУЗКА ДАННЫХ ===
        async function fetchAllData() {
            elements.chartLoader.style.display = 'block';
            elements.newsLoader.style.display = 'block';
            try {
                const [priceResult, newsResult] = await Promise.all([fetchPriceData(), fetchNewsData()]);
                
                if (priceResult) {
                    priceData = priceResult;
                    updateChart(priceData);
                    runFullAnalysis();
                }
                elements.chartLoader.style.display = 'none';

                if (newsResult) {
                    newsData = newsResult;
                    displayNews(newsData);
                }
            } catch (error) { console.error("Критическая ошибка:", error); }
        }

        async function fetchPriceData() {
            const url = `https://financialmodelingprep.com/api/v3/historical-chart/${INTERVAL}/${currentSymbol}?apikey=${API_KEYS.fmp}`;
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`Ошибка сети FMP`);
                const data = await response.json();
                if (!Array.isArray(data) || data.length === 0) throw new Error('FMP не вернул данные');
                return data.map(i=>({time:new Date(i.date).getTime()/1000,open:i.open,high:i.high,low:i.low,close:i.close})).sort((a,b)=>a.time-b.time);
            } catch (error) { console.error("Ошибка цены:", error); return null; }
        }

        async function fetchNewsData() {
            console.log(`Запрос новостей для ${fromSymbolNews} и ${toSymbolNews}...`);
            const url = `https://newsdata.io/api/1/news?apikey=${API_KEYS.newsData}&q=${fromSymbolNews}%20AND%20${toSymbolNews}&language=en&category=business,politics`;
             try {
                const response = await fetch(url);
                if (!response.ok) {
                     const err = await response.json();
                     throw new Error(err.results?.message || 'Ошибка сети NewsData.io');
                }
                const data = await response.json();
                return (data.status === 'success') ? data.results : [];
            } catch (error) { 
                console.error("Ошибка новостей:", error); 
                elements.newsLoader.innerHTML = `<div class="text-center text-warning small">${error.message}</div>`;
                return [];
            }
        }
        
        async function analyzeNewsWithAI(title) {
            console.log(`Новость отправлена в Gemini: "${title}"`);
            const prompt = `Task: Analyze financial news for impact on ${fromSymbolNews}/${toSymbolNews}. Headline: "${title}". Respond strictly: BUY, SELL, or HOLD.`;
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${API_KEYS.gemini}`, {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({contents:[{parts:[{text:prompt}]}]})});
                if (!response.ok) throw new Error(`Ошибка Gemini API`);
                const data = await response.json();
                const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!text) return 'HOLD';
                return (text.match(/(BUY|SELL|HOLD)/i) || ['HOLD'])[0].toUpperCase();
            } catch (error) { console.error("Ошибка Gemini:", error); return 'HOLD'; }
        }

        async function displayNews(items) {
            elements.newsFeed.innerHTML = '';
            if (items.length === 0) {
                elements.newsLoader.innerHTML = `<div class="text-center text-secondary small">Новости не найдены.</div>`;
                return;
            }
            elements.newsLoader.style.display = 'none';
            for (const item of items.slice(0, 2)) {
                const sentiment = await analyzeNewsWithAI(item.title);
                item.sentiment = sentiment; // Сохраняем результат
                const div = document.createElement('div');
                div.className = 'news-item p-2';
                div.innerHTML = `<a href="${item.link}" target="_blank" class="text-decoration-none"><div class="news-title">${item.title}</div><div class="d-flex justify-content-between align-items-center"><span class="news-source">${item.source_id}</span><span class="sentiment-${sentiment.toLowerCase()} fw-bold small">${sentiment}</span></div></a>`;
                elements.newsFeed.appendChild(div);
            }
            runFullAnalysis(); // Пересчитываем прогноз после анализа новостей
        }
        
        // === АНАЛИТИКА ===
        const calc = {
            ema:(d,p)=>{let c=d.map(i=>i.close);if(c.length<p)return null;let k=2/(p+1),e=c.slice(0,p).reduce((a,b)=>a+b,0)/p;for(let i=p;i<c.length;i++)e=(c[i]*k)+(e*(1-k));return e;},
            rsi:(d,p)=>{let c=d.map(i=>i.close);if(c.length<=p)return null;let g=0,l=0;for(let i=1;i<=p;i++){let df=c[i]-c[i-1];if(df>0)g+=df;else l-=df;}let ag=g/p,al=l/p;for(let i=p+1;i<c.length;i++){let df=c[i]-c[i-1];ag=(ag*(p-1)+(df>0?df:0))/p;al=(al*(p-1)+(df<0?-df:0))/p;}if(al===0)return 100;return 100-(100/(1+(ag/al)));},
            macd:(d,f,s)=>{if(d.length<s)return null;let ef=calc.ema(d,f),es=calc.ema(d,s);return(ef&&es)?(ef-es):null;},
            volatility:(d,p)=>{if(d.length<p)return null;let c=d.slice(-p).map(i=>i.close);let ch=c.map((v,i)=>i>0?((v-c[i-1])/c[i-1])*100:0).slice(1);if(ch.length===0)return null;let m=ch.reduce((a,b)=>a+b,0)/ch.length;return Math.sqrt(ch.map(x=>Math.pow(x-m,2)).reduce((a,b)=>a+b,0)/ch.length);},
            trendStrength:(d,p)=>{if(d.length<p)return 0;let e=d.slice(-p).map((_,i,a)=>calc.ema(a.slice(0,i+1),p)).filter(v=>v);if(e.length<2)return 0;return Math.min(Math.abs((e[e.length-1]-e[0])/e.length*10000),1);}
        };

        function runFullAnalysis() {
            if (priceData.length === 0) return;
            let score = 0;
            const rsi = calc.rsi(priceData,14), ema = calc.ema(priceData,20), macd = calc.macd(priceData,12,26);
            elements.rsiValue.textContent=rsi?rsi.toFixed(2):'-'; elements.emaValue.textContent=ema?ema.toFixed(5):'-'; elements.macdValue.textContent=macd?macd.toFixed(5):'-';
            if(rsi){if(rsi>70)score--;else if(rsi<30)score++;} if(ema){if(priceData[priceData.length-1].close>ema)score++;else score--;} if(macd){if(macd>0)score+=0.5;else score-=0.5;}
            
            let newsScore=0, analyzed=newsData.filter(i=>i.sentiment);
            if(analyzed.length>0){analyzed.forEach(i=>{if(i.sentiment==='BUY')newsScore++;if(i.sentiment==='SELL')newsScore--;});let avg=newsScore/analyzed.length,sentiment="NEUTRAL";if(avg>0.3)sentiment="POSITIVE";else if(avg<-0.3)sentiment="NEGATIVE";elements.sentimentValue.textContent=sentiment;if(sentiment==='POSITIVE')score+=1.5;if(sentiment==='NEGATIVE')score-=1.5;}

            scoreHistory.push(score); if (scoreHistory.length > SCORE_HISTORY_LENGTH) scoreHistory.shift();
            const avgScore = scoreHistory.reduce((a, b) => a + b, 0) / scoreHistory.length;
            const timeSinceChange = Date.now() - signalTimestamp;
            
            let finalSignal=currentSignal, timing=elements.predictionTiming.textContent;
            if(avgScore>=SIGNAL_SCORE_THRESHOLD&&currentSignal!=='BUY'){finalSignal='BUY';timing='Вход сейчас. Удержание: 10 мин.';}else if(avgScore<=-SIGNAL_SCORE_THRESHOLD&&currentSignal!=='SELL'){finalSignal='SELL';timing='Вход сейчас. Удержание: 10 мин.';}else if(Math.abs(avgScore)<1.0&&currentSignal!=='HOLD'&&timeSinceChange>MIN_SIGNAL_DURATION){finalSignal='HOLD';timing='Сигнал ослаб. Закрыть позицию.';}

            if(finalSignal!==currentSignal){currentSignal=finalSignal;signalTimestamp=Date.now();if(currentSignal!=='HOLD'){signalExitTimestamp=Date.now()+10*60*1000;startCountdown();}else{stopCountdown();}}
            
            elements.predictionSignal.textContent=finalSignal; elements.predictionSignal.className=`sentiment-${finalSignal.toLowerCase()}`; elements.predictionTiming.textContent=timing;
            
            const vol=calc.volatility(priceData,20),trend=calc.trendStrength(priceData,50);
            if(finalSignal!=='HOLD'&&vol){let c=Math.min(Math.abs(avgScore)/SIGNAL_SCORE_THRESHOLD,1),rf=1/(vol*100||1);let s=Math.max(0.5,Math.min(5,1*c*trend*rf)).toFixed(1)+'%',l=Math.round(Math.max(10,Math.min(200,50*rf*c)))+'x';elements.positionSizeValue.textContent=s;elements.leverageValue.textContent=l;}else{elements.positionSizeValue.textContent='-';elements.leverageValue.textContent='-';}
        }

        function startCountdown(){stopCountdown();updateCountdown();countdownInterval=setInterval(updateCountdown,1000);}
        function stopCountdown(){clearInterval(countdownInterval);elements.countdownTimer.textContent='';}
        function updateCountdown(){const r=signalExitTimestamp-Date.now();if(r<=0){elements.countdownTimer.textContent='Время вышло!';clearInterval(countdownInterval);return;}const m=Math.floor((r/60000)%60),s=Math.floor((r/1000)%60);elements.countdownTimer.textContent=`Выход: ${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;}
        
        init();
    });
    </script>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
