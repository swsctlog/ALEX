<!DOCTYPE html>
<html lang="ru" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading LAB - SYNTERA AI</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Lightweight Charts & Supabase -->
    <script src="https://unpkg.com/lightweight-charts@3.8.0/dist/lightweight-charts.standalone.production.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        :root {
            --bs-body-font-family: 'Inter', sans-serif;
            --bs-body-bg: #f0f2f5;
            --bs-body-color: #1c1e21;
            --card-bg: #ffffff;
            --border-color: #dee2e6;
            --accent-green: #198754;
            --accent-red: #dc3545;
            --accent-blue: #0d6efd;
            --accent-yellow: #ffc107;
        }

        [data-bs-theme="dark"] {
             --bs-body-bg: #131722;
            --bs-body-color: #d1d4dc;
            --card-bg: #1e222d;
            --border-color: #2a2e39;
        }

        body {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        #login-overlay {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background-color: rgba(0, 0, 0, 0.3); backdrop-filter: blur(10px);
            z-index: 1040; display: none; align-items: center; justify-content: center;
        }
        #login-canvas {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
        }
        #login-form-container .modal-content {
            background-color: rgba(10, 25, 47, 0.85); border: 1px solid rgba(13, 110, 253, 0.3);
            border-radius: 1rem; color: #fff; padding: 1rem;
        }
        #login-form-container .modal-header { border-bottom: 0; }
        #login-form-container .form-label { color: #d1d4dc; }
        #login-form-container .form-control {
            background-color: rgba(255, 255, 255, 0.1); border-color: rgba(13, 110, 253, 0.3); color: #fff;
        }
         #login-form-container .form-control:focus {
            background-color: rgba(255, 255, 255, 0.1); border-color: var(--accent-blue);
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25); color: #fff;
        }

        .card {
            background-color: var(--card-bg); border-color: var(--border-color);
            border-radius: 0.75rem; box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        
        .form-control, .form-select { background-color: var(--card-bg); border-color: var(--border-color); }
        .form-control:focus, .form-select:focus {
            background-color: var(--card-bg); border-color: var(--accent-blue);
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25); color: var(--bs-body-color);
        }
        .search-container {
            position: relative;
        }
        #symbol-search {
            padding-left: 2.5rem;
        }
        .search-icon {
            position: absolute; left: 0.75rem; top: 50%; transform: translateY(-50%); color: #6c757d; z-index: 3;
        }
        
        #suggestions {
            position: absolute; top: 100%; left: 0; right: 0; background: var(--card-bg);
            border: 1px solid var(--border-color); border-top: none;
            border-radius: 0 0 0.5rem 0.5rem; z-index: 1056;
        }
        .suggestion-item { padding: 0.75rem 1rem; cursor: pointer; }
        .suggestion-item.disabled { color: #6c757d; cursor: not-allowed; background-color: #e9ecef; }
        .suggestion-item:not(.disabled):hover { background-color: var(--accent-blue); color: white; }
        .suggestion-category {
            padding: 0.5rem 1rem; font-weight: 600; font-size: 0.9rem;
            color: #6c757d; background-color: rgba(0,0,0,0.03);
        }
        
        .btn-icon { background-color: var(--card-bg); border: 1px solid var(--border-color); color: #6c757d; }
        .btn-icon:hover { background-color: #e9ecef; color: var(--bs-body-color); }
        [data-bs-theme="dark"] .btn-icon:hover { background-color: #2a2e39; }
        .animate-spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        .indicator-value { font-size: 1.5rem; font-weight: 600; }
        .indicator-label { color: #6c757d; font-size: 0.8rem; }
        
        .news-item { border-bottom: 1px solid var(--border-color); }
        .news-item:last-child { border-bottom: none; }
        .news-item a { text-decoration: none; color: var(--bs-body-color); }
        .news-item a:hover .news-title { color: var(--accent-blue); }
        .news-title { font-weight: 500; transition: color 0.2s; }
        .news-source { font-size: 0.75rem; color: #6c757d; }
        .btn-expand-news { font-size: 0.75rem; cursor: pointer; }
        .news-summary { font-size: 0.85rem; color: #6c757d; margin-top: 0.5rem; border-left: 3px solid var(--border-color); padding-left: 0.75rem; }
        .news-disabled-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(var(--bs-tertiary-bg-rgb), 0.7); backdrop-filter: blur(4px);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            text-align: center;
        }

        #prediction-signal { font-size: 3.5rem; font-weight: 700; margin: 0.5rem 0; }
        #countdown-timer { font-size: 1.5rem; font-weight: 600; color: var(--accent-blue); }

        .sentiment-buy { color: var(--accent-green); }
        .sentiment-sell { color: var(--accent-red); }
        .sentiment-hold { color: #6c757d; }
        .footer-status {
            position: fixed; bottom: 0; left: 0; width: 100%;
            text-align: center; padding: 4px; font-size: 0.8rem; z-index: 1001;
            transition: background-color 0.3s;
        }
        .footer-status.warning { background-color: var(--accent-yellow); color: black; }
        .footer-status.error { background-color: var(--accent-red); color: white; }
    </style>
</head>
<body>
    
    <!-- Modals (Login & Admin) -->
    <div id="login-overlay">
        <canvas id="login-canvas"></canvas>
        <div id="login-form-container" class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header border-0"><h5 class="modal-title w-100 text-center">Вход в SYNTERA AI</h5></div>
                <div class="modal-body">
                    <div id="login-error" class="alert alert-danger" style="display:none;"></div>
                    <form id="login-form">
                        <div class="mb-3"><label for="username" class="form-label">Логин</label><input type="text" class="form-control" id="username" required></div>
                        <div class="mb-3"><label for="password" class="form-label">Пароль</label><input type="password" class="form-control" id="password" required></div>
                        <div class="form-check mb-3"><input class="form-check-input" type="checkbox" id="remember-me"><label class="form-check-label" for="remember-me">Запомнить меня</label></div>
                        <button type="submit" class="btn btn-primary w-100">Войти</button>
                    </form>
                    <button id="try-free-btn" class="btn btn-outline-light w-100 mt-2">Попробовать бесплатно</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="admin-panel-modal" tabindex="-1"><div class="modal-dialog modal-lg modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Админ-панель</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><h6>Добавить пользователя</h6><form id="add-user-form" class="row g-3 align-items-end mb-4"><div class="col-md-3"><label for="new-username" class="form-label">Логин</label><input type="text" class="form-control" id="new-username" required></div><div class="col-md-3"><label for="new-password" class="form-label">Пароль</label><input type="text" class="form-control" id="new-password" required></div><div class="col-md-3"><label for="new-tarif" class="form-label">Тариф</label><select id="new-tarif" class="form-select"><option value="Essential">Essential</option><option value="PRO">PRO</option></select></div><div class="col-md-2"><div class="form-check"><input class="form-check-input" type="checkbox" id="new-is-admin"><label class="form-check-label" for="new-is-admin">Админ</label></div></div><div class="col-md-1"><button type="submit" class="btn btn-success w-100">OK</button></div></form><h6>Список пользователей</h6><table class="table table-striped"><thead><tr><th>Логин</th><th>Тариф</th><th>Админ</th><th>Действие</th></tr></thead><tbody id="user-list"></tbody></table></div></div></div></div>

    <div class="container-fluid p-3 p-md-4" id="main-content" style="visibility: hidden;">
        <div id="free-tier-alert" class="alert alert-danger text-center p-2" style="display: none;"></div>
        <header class="d-flex justify-content-between align-items-center mb-4 gap-3 flex-wrap">
            <div class="search-container position-relative" style="max-width: 250px;">
                <i data-lucide="search" class="search-icon"></i>
                <input type="text" id="symbol-search" class="form-control" placeholder="Поиск...">
                <div id="suggestions" class="list-group" style="display: none;"></div>
            </div>

            <div class="d-flex gap-3 align-items-center">
                <div id="timeframe-selector" class="btn-group" role="group">
                  <input type="radio" class="btn-check" name="timeframe" id="tf_1min" value="1min" autocomplete="off"><label class="btn btn-outline-primary" for="tf_1min">1м</label>
                  <input type="radio" class="btn-check" name="timeframe" id="tf_5min" value="5min" autocomplete="off"><label class="btn btn-outline-primary" for="tf_5min">5м</label>
                  <input type="radio" class="btn-check" name="timeframe" id="tf_15min" value="15min" autocomplete="off"><label class="btn btn-outline-primary" for="tf_15min">15м</label>
                  <input type="radio" class="btn-check" name="timeframe" id="tf_30min" value="30min" autocomplete="off"><label class="btn btn-outline-primary" for="tf_30min">30м</label>
                  <input type="radio" class="btn-check" name="timeframe" id="tf_1hour" value="1hour" autocomplete="off"><label class="btn btn-outline-primary" for="tf_1hour">1ч</label>
                </div>
                 <div class="form-check form-switch form-check-reverse" id="trading-mode-container" data-bs-toggle="tooltip" title="">
                    <input class="form-check-input" type="checkbox" id="trading-mode-switch">
                    <label class="form-check-label" for="trading-mode-switch">Скальпинг</label>
                </div>
                 <div class="form-check form-switch form-check-reverse" id="ta-mode-container" data-bs-toggle="tooltip" title="Автоматический Тех. Анализ (PRO)">
                    <input class="form-check-input" type="checkbox" id="ta-mode-switch">
                    <label class="form-check-label" for="ta-mode-switch">ФА</label>
                </div>
            </div>

            <div class="d-flex gap-2 align-items-center">
                <span id="user-tariff-badge" class="badge text-bg-secondary"></span>
                <button id="admin-panel-btn" class="btn btn-warning" style="display: none;" data-bs-toggle="modal" data-bs-target="#admin-panel-modal"><i data-lucide="user-cog" class="me-1" style="width:16px;"></i></button>
                <button id="reload-btn" class="btn btn-icon rounded-circle" title="Обновить данные"><i data-lucide="refresh-cw" style="width: 20px; height: 20px;"></i></button>
            </div>
        </header>

        <div class="row g-4">
            <main class="col-lg-8">
                <div class="card h-100"><div class="card-body d-flex flex-column">
                   <h1 id="chart-title" class="card-title fs-5 mb-3"></h1>
                   <div id="chart-container" class="flex-grow-1 position-relative">
                       <div id="chart-loader" class="position-absolute top-50 start-50 translate-middle" style="display: none;">Загрузка...</div>
                   </div>
                </div></div>
            </main>
            <aside class="col-lg-4">
                <div class="vstack gap-4">
                    <div class="card"><div class="card-body text-center">
                        <h2 class="card-title justify-content-center fs-6"><i data-lucide="brain-circuit"></i>Автоматический Прогноз</h2>
                        <div class="row align-items-center">
                            <div class="col"><div id="prediction-signal" class="sentiment-hold">ОЖИДАНИЕ</div><div id="prediction-timing" class="text-secondary small">Анализ...</div></div>
                            <div class="col-4"><div class="indicator-label">Вероятность</div><div id="prediction-probability" class="indicator-value">-</div></div>
                        </div>
                        <div id="countdown-timer" class="mt-2"></div>
                    </div></div>
                    <div class="card"><div class="card-body">
                         <h2 class="card-title justify-content-center fs-6"><i data-lucide="sliders-horizontal"></i>Параметры сделки</h2>
                         <div class="row text-center"><div class="col"><div class="indicator-label">Размер позиции</div><div id="position-size-value" class="indicator-value">-</div></div><div class="col"><div class="indicator-label">Плечо/Мультипликатор</div><div id="leverage-value" class="indicator-value">-</div></div></div>
                    </div></div>
                    <div class="card"><div class="card-body">
                         <h2 class="card-title justify-content-center fs-6"><i data-lucide="activity"></i>Тех. Индикаторы</h2>
                         <div class="row text-center">
                             <div class="col-6 col-md-3 col-lg-6 mb-3"><div class="indicator-label">RSI</div><div id="rsi-value" class="indicator-value">-</div></div>
                             <div class="col-6 col-md-3 col-lg-6 mb-3"><div class="indicator-label">EMA</div><div id="ema-value" class="indicator-value">-</div></div>
                             <div class="col-6 col-md-3 col-lg-6 mb-3"><div class="indicator-label">MACD</div><div id="macd-value" class="indicator-value">-</div></div>
                             <div class="col-6 col-md-3 col-lg-6 mb-3"><div class="indicator-label">Настроение</div><div id="sentiment-value" class="indicator-value">-</div></div>
                         </div>
                    </div></div>
                    <div class="card position-relative"><div class="card-body">
                        <h2 class="card-title fs-6"><i data-lucide="newspaper"></i>Новости</h2>
                        <div id="news-feed" style="max-height: 250px; overflow-y: auto;">
                            <div id="news-loader" class="text-center text-secondary py-3">Загрузка...</div>
                        </div>
                        <div id="news-disabled-overlay" class="news-disabled-overlay" style="display: none;">
                            <i data-lucide="lock" class="mb-2"></i>
                            <div class="fw-bold">Новости отключены</div>
                            <div class="small">Доступно на тарифе PRO</div>
                        </div>
                    </div></div>
                </div>
            </aside>
        </div>
    </div>
    <div id="api-status-footer"></div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {

        var loginAnimationId;
        
        const elements = {
            mainContent: document.getElementById('main-content'), chartContainer: document.getElementById('chart-container'), chartTitle: document.getElementById('chart-title'),
            chartLoader: document.getElementById('chart-loader'), newsLoader: document.getElementById('news-loader'), newsFeed: document.getElementById('news-feed'), 
            symbolSearch: document.getElementById('symbol-search'), suggestions: document.getElementById('suggestions'), reloadBtn: document.getElementById('reload-btn'),
            predictionSignal: document.getElementById('prediction-signal'), predictionTiming: document.getElementById('prediction-timing'),
            countdownTimer: document.getElementById('countdown-timer'), rsiValue: document.getElementById('rsi-value'),
            emaValue: document.getElementById('ema-value'), macdValue: document.getElementById('macd-value'), sentimentValue: document.getElementById('sentiment-value'), 
            positionSizeValue: document.getElementById('position-size-value'), leverageValue: document.getElementById('leverage-value'), 
            timeframeSelector: document.getElementById('timeframe-selector'), apiStatusFooter: document.getElementById('api-status-footer'),
            predictionProbability: document.getElementById('prediction-probability'), searchContainer: document.querySelector('.search-container'),
            tradingModeSwitch: document.getElementById('trading-mode-switch'), tradingModeContainer: document.getElementById('trading-mode-container'),
            taModeSwitch: document.getElementById('ta-mode-switch'), taModeContainer: document.getElementById('ta-mode-container'),
            loginOverlay: document.getElementById('login-overlay'), loginForm: document.getElementById('login-form'), 
            loginError: document.getElementById('login-error'), adminPanelBtn: document.getElementById('admin-panel-btn'), 
            addUserForm: document.getElementById('add-user-form'), userListBody: document.getElementById('user-list'), 
            tryFreeBtn: document.getElementById('try-free-btn'), freeTierAlert: document.getElementById('free-tier-alert'), 
            userTariffBadge: document.getElementById('user-tariff-badge'), newsDisabledOverlay: document.getElementById('news-disabled-overlay')
        };
        
        const SUPABASE_URL = 'https://hlwvsfjxvaackjqqfiuz.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imhsd3ZzZmp4dmFhY2tqcXFmaXV6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTEwNDQ1MjcsImV4cCI6MjA2NjYyMDUyN30.Jf6TuSh-6FcZFa69BgCG5djVIIDWGR8ZTWVrMDPoZLA';
        
        let supabaseClient;
        let currentUser = null;

        try {
            supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        } catch(e) { showLoginError("Ошибка инициализации базы данных."); showLogin(); return; }

        function showLogin() { elements.loginOverlay.style.display = 'flex'; startLoginAnimation(); }
        function hideLogin() { elements.loginOverlay.style.display = 'none'; stopLoginAnimation(); elements.mainContent.style.visibility = 'visible'; }
        function showLoginError(message) { elements.loginError.textContent = message; elements.loginError.style.display = 'block'; }
        
        async function handleLogin(e) { e.preventDefault(); const username = document.getElementById('username').value; const password = document.getElementById('password').value; const rememberMe = document.getElementById('remember-me').checked; const { data, error } = await supabaseClient.from('users').select('*').eq('username', username).eq('password', password).single(); if (error || !data) { showLoginError('Неверный логин или пароль.'); } else { currentUser = data; if (rememberMe) localStorage.setItem('userSession', JSON.stringify(currentUser)); else sessionStorage.setItem('userSession', JSON.stringify(currentUser)); initializeApp(); } }
        function handleFreeTrial() { currentUser = { username: 'Free User', tarif: 'Free', is_admin: false }; sessionStorage.setItem('userSession', JSON.stringify(currentUser)); initializeApp(); }
        
        function initializeApp() {
            hideLogin();
            if(currentUser && currentUser.is_admin) {
                elements.adminPanelBtn.style.display = 'block';
                loadUsersForAdminPanel();
            }
            initTradingApp();
        }

        function checkSession() {
            const session = localStorage.getItem('userSession') || sessionStorage.getItem('userSession');
            if(session) { currentUser = JSON.parse(session); initializeApp(); } 
            else { showLogin(); }
        }
        
        async function loadUsersForAdminPanel() { const{data:a,error:b}=await supabaseClient.from("users").select("*");if(b)return void alert("Не удалось загрузить пользователей");elements.userListBody.innerHTML="",a.forEach(a=>{const b=document.createElement("tr");b.innerHTML=`<td>${a.username}</td><td>${a.tarif}</td><td>${a.is_admin?'<i data-lucide="check-circle" class="text-success"></i>':'<i data-lucide="x-circle" class="text-danger"></i>'}</td><td>${"axmadali"!==a.username?`<button class="btn btn-sm btn-danger" onclick="window.deleteUser(${a.id},'${a.username}')"><i data-lucide="trash-2" style="width:16px;"></i></button>`:""}</td>`,elements.userListBody.appendChild(b)}),lucide.createIcons()}
        async function handleAddUser(e) { e.preventDefault();const a=document.getElementById("new-username").value,b=document.getElementById("new-password").value,c=document.getElementById("new-tarif").value,d=document.getElementById("new-is-admin").checked;const{error:f}=await supabaseClient.from("users").insert({username:a,password:b,tarif:c,is_admin:d});f?alert("Ошибка добавления: "+f.message):(elements.addUserForm.reset(),loadUsersForAdminPanel())}
        window.deleteUser = async (id, username) => { if(confirm(`Удалить пользователя "${username}"?`)){const{error:a}=await supabaseClient.from("users").delete().eq("id",id);a?alert("Ошибка удаления: "+a.message):loadUsersForAdminPanel()}}
        
        elements.loginForm.addEventListener('submit', handleLogin);
        elements.addUserForm.addEventListener('submit', handleAddUser);
        elements.tryFreeBtn.addEventListener('click', handleFreeTrial);

        function initTradingApp() {
            lucide.createIcons();
            
            const API_KEYS = {
                fmp: '3nVpDnD5hpLCCKMBY4GpwsDbBPeJAGch', twelvedata: '8c739af5afd2436c903592832c4afacb',
                newsdata: 'pub_313562b26d2446adae54692160010b3c', gnews: 'dc4bfcbc9258727426cea0be2decd6e6',
                gemini: [ 'AIzaSyCjJCqBok3BFu0iDghJsuOTaTjqWaH0Ck8', 'AIzaSyBhRMmayLeWBcO2uxzEcpR0NNPvTNbrHFM' ]
            };
            const SYMBOLS = { 
                PRO: { "Валюты": ['EURUSD', 'GBPUSD', 'USDJPY', 'USDAUD', 'USDCAD', 'USDCHF'], "Криптовалюты": ['BTCUSD', 'ETHUSD', 'SOLUSD', 'XRPUSD'], "Металлы": ['XAUUSD', 'XAGUSD'] },
                Essential: { "Валюты": ['EURUSD', 'GBPUSD', 'USDJPY', 'USDAUD'], "Криптовалюты": ['BTCUSD', 'ETHUSD'], "Металлы": ['XAUUSD'] },
                Free: { "Криптовалюты": ['BTCUSD', 'SOLUSD'], "Валюты": ['EURUSD'] }
            };

            let currentSymbol, currentTimeframe, currentTradingMode, fromSymbolNews, toSymbolNews;
            let chart, candleSeries, priceData = [], newsData = [], scoreHistory = [];
            let currentSignal = 'HOLD', signalTimestamp = 0;
            let countdownInterval, signalExitTimestamp = 0;
            let apiStatus = { price: true, news: true };
            let preferredPriceApi = 'fmp'; 
            let preferredNewsApi = 'newsdata';
            let currentGeminiKeyIndex = 0;
            
            const SCORE_SENSITIVITY = 1.8;
            const SCORE_HISTORY_LENGTH = 3;
            
            init();

            function init() {
                applyTariffRestrictions();
                initChart();
                setupEventListeners();
                parseSymbol(currentSymbol);
                document.querySelector(`input[name="timeframe"][value="${currentTimeframe}"]`).checked = true;
                elements.tradingModeSwitch.checked = currentTradingMode === "scalping";
                elements.tradingModeSwitch.nextElementSibling.textContent = elements.tradingModeSwitch.checked ? 'Скальпинг' : 'Долгосрок';
                checkSignalTimer();
                fetchAllData();
                setInterval(fetchAllData, 60000);
            }

            function applyTariffRestrictions() {
                const tariff = currentUser.tarif || 'Free';
                elements.userTariffBadge.textContent = tariff;
                const availableSymbols = SYMBOLS[tariff] || SYMBOLS.Free;
                const allAvailableSymbols = Object.values(availableSymbols).flat();
                
                currentSymbol = localStorage.getItem('tradingDashboardSymbol') || allAvailableSymbols[0];
                if (!allAvailableSymbols.includes(currentSymbol)) {
                    currentSymbol = allAvailableSymbols[0];
                }
                
                if (tariff === 'Free') {
                    currentTradingMode = 'longterm';
                    elements.tradingModeContainer.setAttribute('data-bs-title', 'Доступно на платных тарифах');
                    new bootstrap.Tooltip(elements.tradingModeContainer);
                    elements.tradingModeSwitch.disabled = true;
                    elements.newsDisabledOverlay.style.display = 'none';
                    elements.taModeContainer.style.display = 'none';
                    updateFreeTierAlert();
                } else if (tariff === 'Essential') {
                    currentTradingMode = localStorage.getItem('tradingDashboardMode') || 'longterm';
                    elements.tradingModeSwitch.disabled = false;
                    elements.tradingModeContainer.removeAttribute('data-bs-title');
                    elements.newsDisabledOverlay.style.display = 'flex';
                    elements.taModeContainer.style.display = 'none';
                    elements.freeTierAlert.style.display = 'none';
                } else { // PRO
                    currentTradingMode = localStorage.getItem('tradingDashboardMode') || 'scalping';
                    elements.tradingModeSwitch.disabled = false;
                    elements.tradingModeContainer.removeAttribute('data-bs-title');
                    elements.newsDisabledOverlay.style.display = 'none';
                    elements.taModeContainer.style.display = 'block';
                    elements.freeTierAlert.style.display = 'none';
                }
                currentTimeframe = localStorage.getItem('tradingDashboardTimeframe') || '1min';
            }

            function initChart() { if(chart)chart.remove();const a=getComputedStyle(document.documentElement),b={background:a.getPropertyValue("--card-bg").trim(),text:a.getPropertyValue("--bs-body-color").trim(),border:a.getPropertyValue("--border-color").trim(),accentGreen:a.getPropertyValue("--accent-green").trim(),accentRed:a.getPropertyValue("--accent-red").trim()};chart=LightweightCharts.createChart(elements.chartContainer,{layout:{backgroundColor:b.background,textColor:b.text},grid:{vertLines:{color:b.border},horzLines:{color:b.border}},timeScale:{timeVisible:!0,secondsVisible:!1,borderColor:b.border,timezone:"Asia/Tashkent"},crosshair:{mode:LightweightCharts.CrosshairMode.Normal}}),candleSeries=chart.addCandlestickSeries({upColor:b.accentGreen,downColor:b.accentRed,borderDownColor:b.accentRed,borderUpColor:b.accentGreen,wickDownColor:b.accentRed,wickUpColor:b.accentGreen});const c=JSON.parse(localStorage.getItem("chartVisibleRange"));c&&chart.timeScale().setVisibleLogicalRange(c),chart.timeScale().subscribeVisibleLogicalRangeChange(a=>{localStorage.setItem("chartVisibleRange",JSON.stringify(a))}),window.addEventListener("resize",()=>chart.resize(elements.chartContainer.clientWidth,elements.chartContainer.clientHeight))}
            function setupEventListeners() {
                elements.reloadBtn.addEventListener('click', () => {
                    elements.reloadBtn.querySelector('svg').classList.add('animate-spin');
                    fetchAllData().finally(() => setTimeout(() => elements.reloadBtn.querySelector('svg').classList.remove('animate-spin'), 500));
                });
                elements.symbolSearch.addEventListener('input', showSuggestions);
                elements.symbolSearch.addEventListener('focus', showSuggestions);
                document.addEventListener('click', e => {
                    if (elements.searchContainer && !elements.searchContainer.contains(e.target)) elements.suggestions.style.display = 'none';
                });
                elements.timeframeSelector.addEventListener('change', e => {
                    currentTimeframe = e.target.value;
                    localStorage.setItem('tradingDashboardTimeframe', currentTimeframe);
                    resetAndFetch();
                });
                elements.tradingModeSwitch.addEventListener('change', e => {
                    if (currentUser.tarif === 'Free') {
                        e.target.checked = false;
                        alert('Переключение режимов доступно на платных тарифах.');
                        return;
                    }
                    currentTradingMode = e.target.checked ? "scalping" : "longterm";
                    elements.tradingModeSwitch.nextElementSibling.textContent = e.target.checked ? 'Скальпинг' : 'Долгосрок';
                    if(currentTradingMode === 'scalping' && currentUser.tarif === 'PRO') {
                        currentTimeframe = '1min';
                        document.getElementById('tf_1min').checked = true;
                        Array.from(elements.timeframeSelector.querySelectorAll('input')).forEach(inp => inp.disabled = true);
                        elements.timeframeSelector.querySelector('input[value="1min"]').disabled = false;

                    } else {
                         Array.from(elements.timeframeSelector.querySelectorAll('input')).forEach(inp => inp.disabled = false);
                    }
                    localStorage.setItem('tradingDashboardMode', currentTradingMode);
                    resetAndFetch();
                });
            }
            
            function parseSymbol(symbol) {
                 if (symbol.length === 6) { fromSymbolNews = symbol.substring(0, 3); toSymbolNews = symbol.substring(3, 6); } 
                 else { fromSymbolNews = symbol.replace('USD',''); toSymbolNews = 'USD'; }
                elements.chartTitle.innerHTML = `<i data-lucide="line-chart"></i> График ${fromSymbolNews}/${toSymbolNews} (${currentTimeframe})`;
                lucide.createIcons();
            }

            function changeSymbol(newSymbol) {
                currentSymbol = newSymbol;
                localStorage.setItem('tradingDashboardSymbol', newSymbol);
                resetAndFetch();
            }
            
            function resetAndFetch() { parseSymbol(currentSymbol); priceData = []; newsData = []; scoreHistory = []; currentSignal = 'HOLD'; elements.predictionSignal.textContent = 'ОЖИДАНИЕ'; elements.predictionTiming.textContent = 'Анализ...'; stopCountdown(); fetchAllData(); }
            
            function showSuggestions() {
                const query = elements.symbolSearch.value.toUpperCase();
                elements.suggestions.innerHTML = '';
                const symbolMap = SYMBOLS.PRO; 
                const availableSymbols = SYMBOLS[currentUser.tarif] || SYMBOLS.Free;
                const allAvailableSymbols = Object.values(availableSymbols).flat();

                for (const category in symbolMap) {
                    const filtered = symbolMap[category].filter(symbol => symbol.includes(query));
                    if (filtered.length > 0) {
                        const catHeader = document.createElement('div');
                        catHeader.className = 'suggestion-category';
                        catHeader.textContent = category;
                        elements.suggestions.appendChild(catHeader);
                        filtered.forEach(s => {
                            const item = document.createElement('a');
                            const isAvailable = allAvailableSymbols.includes(s);
                            item.className = `suggestion-item list-group-item list-group-item-action ${isAvailable ? '' : 'disabled'}`;
                            item.textContent = s;
                            if (isAvailable) {
                                item.onclick = () => { elements.symbolSearch.value = s; elements.suggestions.style.display = 'none'; changeSymbol(s); };
                            } else {
                                item.title = "Доступно на более высоком тарифе";
                            }
                            elements.suggestions.appendChild(item);
                        });
                    }
                }
                 elements.suggestions.style.display = 'block';
            }

            function updateChart(data) { if (candleSeries) { candleSeries.setData(data); setTimeout(() => chart.timeScale().fitContent(), 50); } }
            
            async function fetchAllData() {
                if(checkPredictionLimit()) return;
                elements.chartLoader.style.display = 'block';
                elements.newsLoader.innerHTML = `<div class="text-center text-secondary py-3">Загрузка...</div>`;
                const [priceResult, newsResult] = await Promise.all([fetchPriceData(), fetchNewsData()]);
                
                apiStatus.price = priceResult.success;
                apiStatus.news = newsResult.success;

                elements.chartLoader.style.display = 'none';
                if (priceResult.success) {
                    priceData = priceResult.data;
                    updateChart(priceData);
                }
                
                if (newsResult.success) {
                    newsData = newsResult.data;
                    displayNews(newsData);
                }

                runFullAnalysis();
                updateApiStatusFooter();
            }
            
            function getApiTimeframe(apiName) {
                const map = {
                    '1min': { twelvedata: '1min', fmp: '1min' },
                    '5min': { twelvedata: '5min', fmp: '5min' },
                    '15min': { twelvedata: '15min', fmp: '15min' },
                    '30min': { twelvedata: '30min', fmp: '30min' },
                    '1hour': { twelvedata: '1h', fmp: '1hour' }
                };
                return map[currentTimeframe]?.[apiName] || currentTimeframe;
            }

            async function fetchPriceFromFMP() {
                const url = `https://financialmodelingprep.com/api/v3/historical-chart/${getApiTimeframe('fmp')}/${currentSymbol}?apikey=${API_KEYS.fmp}`;
                try {
                    const response = await fetch(url);
                    if (!response.ok) throw new Error("Ошибка сети FMP");
                    const data = await response.json();
                    if (!Array.isArray(data) || data.length === 0) throw new Error("FMP не вернул данные");
                    return { success: true, data: data.map(i=>({time:new Date(i.date).getTime()/1000,open:i.open,high:i.high,low:i.low,close:i.close})).sort((a,b)=>a.time-b.time) };
                } catch (error) { console.error("Ошибка цены (FMP):", error); return { success: false, error: error.message }; }
            }
            
            async function fetchPriceFromTwelveData() {
                const symbol = `${fromSymbolNews}/${toSymbolNews}`;
                const url = `https://api.twelvedata.com/time_series?symbol=${symbol}&interval=${getApiTimeframe('twelvedata')}&outputsize=5000&apikey=${API_KEYS.twelvedata}`;
                try {
                    const response = await fetch(url);
                    if (!response.ok) { const error = await response.json(); throw new Error(`Ошибка Twelve Data: ${error.message}`); }
                    const data = await response.json();
                    if (data.status === 'error' || !data.values) throw new Error(`Ошибка Twelve Data: ${data.message || 'Неверный ответ'}`);
                    const formatted = data.values.map(v => ({ time: new Date(v.datetime).getTime()/1000, open: parseFloat(v.open), high: parseFloat(v.high), low: parseFloat(v.low), close: parseFloat(v.close) })).reverse();
                    return { success: true, data: formatted };
                } catch (error) { console.error("Ошибка цены (Twelve Data):", error); return { success: false, error: error.message }; }
            }
            
            async function fetchPriceData() { let a;return"fmp"===preferredPriceApi?(a=await fetchPriceFromFMP(),a.success||(console.log("FMP failed, falling back to Twelve Data"),preferredPriceApi="twelvedata",a=await fetchPriceFromTwelveData())):(a=await fetchPriceFromTwelveData(),a.success||(console.log("Twelve Data failed, falling back to FMP"),preferredPriceApi="fmp",a=await fetchPriceFromFMP())),a.success||(elements.chartLoader.innerHTML=`<div class="text-center text-danger small p-3">${a.error}</div>`),a}
            async function fetchNewsData() { if("Essential"===currentUser.tarif)return{success:!1,error:"Новости отключены на тарифе"};let a;return"newsdata"===preferredNewsApi?(a=await fetchNewsFromNewsData(),a.success||(console.log("NewsData.io failed, falling back to GNews.io"),preferredNewsApi="gnews",a=await fetchNewsFromGNews())):(a=await fetchNewsFromGNews(),a.success||(console.log("GNews.io failed, falling back to NewsData.io"),preferredNewsApi="newsdata",a=await fetchNewsFromNewsData())),a}
            async function fetchNewsFromNewsData() { const a=`https://newsdata.io/api/1/news?apikey=${API_KEYS.newsdata}&q=${fromSymbolNews}%20OR%20${toSymbolNews}&language=en&category=business,politics`;try{const b=await fetch(a);if(!b.ok){const c=await b.json();throw new Error(c.results?.message||"Ошибка сети NewsData.io")}const d=await b.json();return{success:!0,data:"success"===d.status?d.results:[]}}catch(e){return console.error("Ошибка NewsData.io:",e),elements.newsLoader.innerHTML=`<div class="text-center text-warning small">${e.message}</div>`,{success:!1,error:e.message}}}
            async function fetchNewsFromGNews() { const a=`${fromSymbolNews} OR ${toSymbolNews}`,b=`https://gnews.io/api/v4/search?q=${encodeURIComponent(a)}&lang=en&country=us&max=10&token=${API_KEYS.gnews}`;try{const c=await fetch(b);if(!c.ok){const d=await c.json();throw new Error(d.errors.join(", ")||"Ошибка сети GNews.io")}const e=await c.json(),f=e.articles.map(a=>({...a,source_id:a.source.name,pubDate:a.publishedAt,link:a.url}));return{success:!0,data:f}}catch(g){return console.error("Ошибка GNews.io:",g),elements.newsLoader.innerHTML=`<div class="text-center text-warning small">${g.message}</div>`,{success:!1,error:g.message}}}
            async function analyzeNewsWithAI(title, type) { const a=API_KEYS.gemini[currentGeminiKeyIndex],b="sentiment"===type?`Task: Analyze financial news for impact on ${fromSymbolNews}/${toSymbolNews}. Headline: "${title}". Respond strictly: BUY, SELL, or HOLD.`:`Task: Summarize this financial news headline in one short Russian sentence. Headline: "${title}"`;try{const c=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${a}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contents:[{parts:[{text:b}]}]})});if(!c.ok)throw new Error("Ошибка Gemini API");const d=await c.json(),e=d.candidates?.[0]?.content?.parts?.[0]?.text;return e?"sentiment"===type?(e.match(/(BUY|SELL|HOLD)/i)||[ "HOLD" ])[0].toUpperCase():e:"sentiment"===type?"HOLD":"Не удалось получить изложение."}catch(f){return console.error("Ошибка Gemini:",f),currentGeminiKeyIndex=(currentGeminiKeyIndex+1)%API_KEYS.gemini.length,console.log(`Переключение на следующий ключ Gemini: #${currentGeminiKeyIndex}`),"sentiment"===type?"HOLD":"Ошибка анализа."}}
            async function displayNews(items) {
                elements.newsFeed.innerHTML = '';
                if (items.length === 0) { elements.newsFeed.innerHTML = `<div class="text-center text-secondary small">Новости не найдены.</div>`; return; }
                for (const [index, item] of items.slice(0, 2).entries()) {
                    item.sentiment = await analyzeNewsWithAI(item.title, 'sentiment');
                    const div = document.createElement('div');
                    div.className = 'news-item p-2';
                    div.innerHTML = `
                        <div class="d-flex justify-content-between align-items-start">
                            <a href="${item.link || item.url}" target="_blank" class="text-decoration-none w-100">
                                <div class="news-title">${item.title}</div><div class="news-source">${item.source_id || item.source.name}</div>
                            </a>
                            <span class="sentiment-${item.sentiment.toLowerCase()} fw-bold small ms-2">${item.sentiment}</span>
                        </div>
                        <div class="text-primary small mt-1 btn-expand-news" style="cursor: pointer;"><span>Развернуть</span> <i data-lucide="chevron-down" style="width:12px;"></i></div>
                        <div class="news-summary" style="display: none;"></div>`;
                    elements.newsFeed.appendChild(div);

                    div.querySelector('.btn-expand-news').addEventListener('click', async (e) => {
                        const btn = e.currentTarget;
                        const summaryDiv = btn.nextElementSibling;
                        if (summaryDiv) {
                            const span = btn.querySelector("span");
                            if (summaryDiv.style.display === 'none') {
                                summaryDiv.innerHTML = 'Загрузка изложения...';
                                summaryDiv.style.display = 'block';
                                btn.innerHTML = 'Свернуть <i data-lucide="chevron-up" style="width:12px;"></i>';
                                summaryDiv.textContent = await analyzeNewsWithAI(items[index].title, 'summary');
                            } else {
                                summaryDiv.style.display = 'none';
                                btn.innerHTML = 'Развернуть <i data-lucide="chevron-down" style="width:12px;"></i>';
                            }
                            lucide.createIcons();
                        }
                    });
                }
                lucide.createIcons();
                runFullAnalysis();
            }
            
            const calc = { ema:(d,p)=>{let c=d.map(i=>i.close);if(c.length<p)return null;let k=2/(p+1),e=c.slice(0,p).reduce((a,b)=>a+b,0)/p;for(let i=p;i<c.length;i++)e=(c[i]*k)+(e*(1-k));return e;}, rsi:(d,p)=>{let c=d.map(i=>i.close);if(c.length<=p)return null;let g=0,l=0;for(let i=1;i<=p;i++){let df=c[i]-c[i-1];if(df>0)g+=df;else l-=df;}let ag=g/p,al=l/p;for(let i=p+1;i<c.length;i++){let df=c[i]-c[i-1];ag=(ag*(p-1)+(df>0?df:0))/p;al=(al*(p-1)+(df<0?-df:0))/p;}if(al===0)return 100;return 100-(100/(1+(ag/al)));}, macd:(d,f,s)=>{if(d.length<s)return null;let ef=calc.ema(d,f),es=calc.ema(d,s);return(ef&&es)?(ef-es):null;}, volatility:(d,p)=>{if(d.length<p)return null;let c=d.slice(-p).map(i=>i.close);let ch=c.map((v,i)=>i>0?((v-c[i-1])/c[i-1])*100:0).slice(1);if(ch.length===0)return null;let m=ch.reduce((a,b)=>a+b,0)/ch.length;return Math.sqrt(ch.map(x=>Math.pow(x-m,2)).reduce((a,b)=>a+b,0)/ch.length);}, trendStrength:(d,p)=>{if(d.length<p)return 0;let e=d.slice(-p).map((_,i,a)=>calc.ema(a.slice(0,i+1),p)).filter(v=>v);if(e.length<2)return 0;return Math.min(Math.abs((e[e.length-1]-e[0])/e.length*10000),1);} };
            
            function runFullAnalysis() {
                if (!apiStatus.price || priceData.length < 2) {
                    elements.predictionSignal.textContent = 'ОШИБКА'; elements.predictionTiming.textContent = 'Нет данных для анализа.'; elements.predictionProbability.textContent = '0%';
                    return;
                }
                let score = 0;
                const rsi = calc.rsi(priceData, 14), ema = calc.ema(priceData, 20), macd = calc.macd(priceData, 12, 26);
                elements.rsiValue.textContent = rsi ? rsi.toFixed(2) : '-'; elements.emaValue.textContent = ema ? ema.toFixed(5) : '-'; elements.macdValue.textContent = macd ? macd.toFixed(5) : '-';
                
                const rsiUpper = currentTradingMode === 'scalping' ? 70 : 75;
                const rsiLower = currentTradingMode === 'scalping' ? 30 : 25;

                if (rsi) { if (rsi > rsiUpper) score--; else if (rsi < rsiLower) score++; }
                if (ema) { if (priceData[priceData.length-1].close > ema) score++; else score--; }
                if (macd) { if (macd > 0) score += 0.5; else score -= 0.5; }
                
                let newsScore = 0, analyzed = newsData.filter(i => i.sentiment);
                if (apiStatus.news && analyzed.length > 0) {
                    analyzed.forEach(i => { if (i.sentiment === 'BUY') newsScore++; if (i.sentiment === 'SELL') newsScore--; });
                    let avg = newsScore / analyzed.length, sentiment = "NEUTRAL";
                    if (avg > 0.3) sentiment = "POSITIVE"; else if (avg < -0.3) sentiment = "NEGATIVE";
                    elements.sentimentValue.textContent = sentiment;
                    if (sentiment === 'POSITIVE') score += 0.5; if (sentiment === 'NEGATIVE') score -= 0.5;
                } else { elements.sentimentValue.textContent = 'N/A'; }

                scoreHistory.push(score); if (scoreHistory.length > SCORE_HISTORY_LENGTH) scoreHistory.shift();
                const avgScore = scoreHistory.reduce((a, b) => a + b, 0) / scoreHistory.length;
                
                const trend = calc.trendStrength(priceData, 50);
                let probability = 50 + (Math.abs(avgScore) / SCORE_SENSITIVITY * 25) + (trend * 15);
                if (!apiStatus.news) probability -= 20;
                probability = Math.round(Math.max(30, Math.min(95, probability)));
                elements.predictionProbability.textContent = `${probability}%`;
                
                const timeframeMinutes = {'1min':1,'5min':5,'15min':15,'30min':30,'1hour':60}[currentTimeframe];
                const holdMultiplier = currentTradingMode === 'scalping' ? 3 : 5;
                const holdMinutes = timeframeMinutes * holdMultiplier;
                const timeSinceChange = Date.now() - signalTimestamp;
                
                let finalSignal = currentSignal, timing = elements.predictionTiming.textContent;
                
                const scoreThreshold = currentTradingMode === 'scalping' ? SCORE_SENSITIVITY - 0.4 : SCORE_SENSITIVITY;

                if (avgScore >= scoreThreshold && currentSignal !== 'BUY' && trend > 0.2) {
                    finalSignal = 'BUY'; timing = `Вход сейчас. Удержание: ~${holdMinutes} мин.`;
                } else if (avgScore <= -scoreThreshold && currentSignal !== 'SELL' && trend > 0.2) {
                    finalSignal = 'SELL'; timing = `Вход сейчас. Удержание: ~${holdMinutes} мин.`;
                } else if (Math.abs(avgScore) < 0.8 && currentSignal !== 'HOLD' && timeSinceChange > (holdMinutes / 2 * 60 * 1000)) {
                    finalSignal = 'HOLD'; timing = 'Сигнал ослаб. Закрыть позицию.';
                }

                if (finalSignal !== currentSignal && finalSignal !== 'HOLD') {
                    if(checkAndIncrementSignalCount()) {
                        currentSignal = finalSignal; signalTimestamp = Date.now();
                        signalExitTimestamp = Date.now() + holdMinutes * 60 * 1000;
                        localStorage.setItem('signalExitTimestamp', signalExitTimestamp);
                        startCountdown();
                    } else {
                        finalSignal = 'HOLD';
                        alert('Достигнут лимит прогнозов для вашего тарифа. Приобретите подписку для продолжения.');
                    }
                } else if (finalSignal === 'HOLD' && currentSignal !== 'HOLD') {
                    currentSignal = 'HOLD';
                    stopCountdown();
                }
                
                elements.predictionSignal.textContent = finalSignal; elements.predictionSignal.className = `sentiment-${finalSignal.toLowerCase()}`; elements.predictionTiming.textContent = timing;
                
                const vol = calc.volatility(priceData, 20);
                if (finalSignal !== 'HOLD' && vol) {
                    let c = probability / 100, rf = 1 / (vol * 100 || 1);
                    let s = Math.max(0.5, Math.min(5, 1 * c * trend * rf)).toFixed(1) + '%';
                    let l = Math.round(Math.max(10, Math.min(200, 50 * rf * c))) + 'x';
                    elements.positionSizeValue.textContent = s; elements.leverageValue.textContent = l;
                } else {
                    elements.positionSizeValue.textContent = '-'; elements.leverageValue.textContent = '-';
                }
            }
            
            function updateApiStatusFooter() { if(!apiStatus.price&&!apiStatus.news)elements.apiStatusFooter.className="footer-status error",elements.apiStatusFooter.textContent="Вам лимит на сегодня превышен.";else if(!apiStatus.price||!apiStatus.news)elements.apiStatusFooter.className="footer-status warning",elements.apiStatusFooter.textContent="Один или несколько источников данных недоступны. Прогноз может быть неточным.";else elements.apiStatusFooter.className="",elements.apiStatusFooter.textContent=""}
            function startCountdown() { stopCountdown(); updateCountdown(); countdownInterval = setInterval(updateCountdown, 1000); }
            function stopCountdown() { clearInterval(countdownInterval); elements.countdownTimer.textContent = ''; localStorage.removeItem('signalExitTimestamp'); }
            function updateCountdown() { const r = signalExitTimestamp - Date.now(); if(r <= 0) { elements.countdownTimer.textContent = 'Время вышло!'; stopCountdown(); return; } const m = Math.floor((r / 60000) % 60), s = Math.floor((r / 1000) % 60); elements.countdownTimer.textContent = `Выход: ${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`; }
            function checkSignalTimer() { const exitTs = localStorage.getItem('signalExitTimestamp'); if (exitTs && parseInt(exitTs) > Date.now()) { signalExitTimestamp = parseInt(exitTs); startCountdown(); } }
            
            function getSignalCountKey() { return `signalCount_${currentUser.username || 'free'}`; }
            function updateFreeTierAlert() {
                if (currentUser.tarif !== 'Free') return;
                const key = getSignalCountKey();
                let data = JSON.parse(localStorage.getItem(key)) || { date: '1970-01-01', count: 0 };
                const today = new Date().toISOString().slice(0, 10);
                if (data.date !== today) data.count = 0;
                elements.freeTierAlert.textContent = `Вы используете бесплатный тариф. Доступно прогнозов сегодня: ${2 - data.count} из 2.`;
                elements.freeTierAlert.style.display = 'block';
            }
            function checkPredictionLimit() {
                const limit = { 'Free': 2, 'Essential': 10 }[currentUser.tarif];
                if (!limit) return false;

                const key = getSignalCountKey();
                let data = JSON.parse(localStorage.getItem(key)) || { date: '1970-01-01', count: 0 };
                const today = new Date().toISOString().slice(0, 10);
                if (data.date !== today) {
                    data = { date: today, count: 0 };
                    localStorage.setItem(key, JSON.stringify(data));
                }
                if (data.count >= limit) {
                    alert('Достигнут лимит прогнозов для вашего тарифа. Приобретите подписку для продолжения.');
                    return true;
                }
                return false;
            }
            function checkAndIncrementSignalCount() {
                const limit = { 'Free': 2, 'Essential': 10 }[currentUser.tarif];
                if (!limit) return true;
                const key = getSignalCountKey();
                let data = JSON.parse(localStorage.getItem(key)) || { date: '1970-01-01', count: 0 };
                const today = new Date().toISOString().slice(0, 10);
                if (data.date !== today) data = { date: today, count: 0 };
                if (data.count < limit) {
                    data.count++;
                    localStorage.setItem(key, JSON.stringify(data));
                    if (currentUser.tarif === 'Free') updateFreeTierAlert();
                    return true;
                }
                return false;
            }
        }
        
        function startLoginAnimation() {
            const canvas = document.getElementById('login-canvas');
            const ctx = canvas.getContext('2d');
            let width = canvas.width = window.innerWidth;
            let height = canvas.height = window.innerHeight;
            let candles = [];
            const candleWidth = 10;
            let animationInterval;

            function createCandle() {
                const open = height / 2 + (Math.random() - 0.5) * 200;
                const close = open + (Math.random() - 0.5) * 50;
                candles.push({ x: width, open, high: Math.max(open, close) + Math.random() * 20, low: Math.min(open, close) - Math.random() * 20, close: close });
                if (candles.length > width / (candleWidth + 5)) candles.shift();
            }
            function draw() {
                ctx.clearRect(0, 0, width, height);
                candles.forEach(c => {
                    c.x -= 2;
                    ctx.strokeStyle = c.close >= c.open ? 'rgba(25, 135, 84, 0.7)' : 'rgba(220, 53, 69, 0.7)';
                    ctx.fillStyle = ctx.strokeStyle;
                    ctx.beginPath();
                    ctx.moveTo(c.x + candleWidth / 2, c.high);
                    ctx.lineTo(c.x + candleWidth / 2, c.low);
                    ctx.stroke();
                    ctx.fillRect(c.x, Math.min(c.open, c.close), candleWidth, Math.abs(c.open - c.close));
                });
            }
            createCandle();
            animationInterval = setInterval(createCandle, 200);
            function animate() { draw(); loginAnimationId = requestAnimationFrame(animate); }
            animate();

            window.stopLoginAnimation = () => {
                 cancelAnimationFrame(loginAnimationId);
                 clearInterval(animationInterval);
            };
        }
        function stopLoginAnimation() { if (window.stopLoginAnimation) window.stopLoginAnimation(); }
        
        checkSession();
    });
    </script>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
